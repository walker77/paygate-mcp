name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - run: npm test

  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - run: npm run test:coverage
      - name: Check coverage thresholds
        run: |
          node -e "
            const data = require('./coverage/coverage-summary.json');
            const t = data.total;
            const pass = t.lines.pct >= 80 && t.functions.pct >= 80;
            console.log('Lines:     ' + t.lines.pct + '%');
            console.log('Branches:  ' + t.branches.pct + '%');
            console.log('Functions: ' + t.functions.pct + '%');
            console.log('Statements:' + t.statements.pct + '%');
            if (!pass) { console.error('Coverage below 80% threshold'); process.exit(1); }
            console.log('Coverage thresholds met');
          "

  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t paygate-mcp:ci .
      - name: Verify image starts
        run: |
          docker run -d --name paygate-ci -p 3000:3000 \
            -e PAYGATE_SERVER_COMMAND=echo paygate-mcp:ci wrap -- echo test
          sleep 3
          curl -sf http://localhost:3000/health | grep -q '"status":"ok"' && echo "Health check passed" || (docker logs paygate-ci && exit 1)
          docker stop paygate-ci
